-- hive
-- by john ziolkowski

state = "start"
player = nil

c = 8
b = 128 / c

⬅️ = 0
➡️ = 1
⬆️ = 2
⬇️ = 3
🅾️ = 4
❎ = 5

bee = 1
ant = 2
spi = 3
gra = 4
btl = 5

board = {{{}}}
hands = {}
palt(0, false)
palt(14, true)

//team (0 is none)
//sprite for bug (1-5)
cur = {c=8, r=8, t=0, s=0}

function init_hands()
 for p = 1,2 do
  hands[p] = {}
  add(hands[p],{t=p, s=bee})
  add(hands[p],{t=p, s=ant})
  add(hands[p],{t=p, s=ant})
  add(hands[p],{t=p, s=ant})
  add(hands[p],{t=p, s=spi})
  add(hands[p],{t=p, s=spi})
  add(hands[p],{t=p, s=gra})
  add(hands[p],{t=p, s=gra})
  add(hands[p],{t=p, s=gra})
  add(hands[p],{t=p, s=btl})
  add(hands[p],{t=p, s=btl})
 end
end

function init_board()
	for row = 1,b do
	 board[row] = {}
	 for col = 1,b do
	  //leave out off screen cells
	  if not (row%2 == 1 and col == b) then
	   board[row][col] = {}
	   sprite = flr(rnd(20)) + 1
	   if sprite > 5 then
	   	sprite = 0
	   	team = 0
	   else
	    team = flr(rnd(2)) + 1
	   end
	   board[row][col] = {t=team, s=sprite}
	  end
	 end
	end
end

init_board()

function reset()
 player = 2
 init_board()
 init_hands()
 state = "playing"
end

function game_over()
 state = "over"
end

function grab_or_place()
 local r = cur.r
 local c = cur.c
 if cur.t == 0 then
  //grab if cursor empty
  if board[r][c].t != 0 then
   cur.t = board[r][c].t
   cur.s = board[r][c].s
   board[r][c].t = 0
   board[r][c].s = 0
  end
 else
  //place if cell empty
  if board[r][c].t == 0 then
   board[r][c].t = cur.t
   board[r][c].s = cur.s
   cur.s = 0
   cur.t = 0
  end
 end
end

function toggle_player()
 if player == 1 then
  player = 2
 elseif player == 2 then
  player = 1
 end
end

function _update()
 if state == "start" or
    state == "over" then
  if(btn(🅾️)) then
   reset()
  end
 elseif state == "playing" then
  if btnp(⬅️) then cur.c-=1 end
  if btnp(➡️) then cur.c+=1 end
  if btnp(⬆️) then cur.r-=1 end
  if btnp(⬇️) then cur.r+=1 end
  if cur.c < 1 then cur.c=1 end
  if cur.c > b then cur.c=b end
  if cur.r < 1 then cur.r=1 end
  if cur.r > b then cur.r=b end
  if cur.r%2==1 and cur.c==b then
   cur.c=b-1
  end	  
  if btnp(🅾️) then
   grab_or_place()
  end
  if btnp(❎) then
   toggle_player()
  end
 end
end
